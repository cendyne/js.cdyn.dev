const blurhash=function(t){const e=t=>{let e=0;for(let a=0;a<t.length;a++){const r=t[a];e=83*e+"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz#$%*+,-.:;=?@[]^_{|}~".indexOf(r)}return e},a=t=>{let e=t/255;return e<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)},r=t=>{let e=Math.max(0,Math.min(1,t));return e<=.0031308?Math.round(12.92*e*255+.5):Math.round(255*(1.055*Math.pow(e,1/2.4)-.055)+.5)},o=(t,e)=>(t<0?-1:1)*Math.pow(Math.abs(t),e),l=t=>{const e=t>>8&255,r=255&t;return[a(t>>16),a(e),a(r)]},s=(t,e)=>{const a=Math.floor(t/361),r=Math.floor(t/19)%19,l=t%19;return[o((a-9)/9,2)*e,o((r-9)/9,2)*e,o((l-9)/9,2)*e]};return t.decodePromise=(e,a,r,o=1)=>new Promise(((l,s)=>{l(t.decode(e,a,r,o))})),t.decode=(t,a,o,n=1)=>{(t=>{if(!t||t.length<6)throw new Error("The blurhash string must be at least 6 characters");const a=e(t[0]),r=Math.floor(a/9)+1,o=a%9+1;if(t.length!==4+2*o*r)throw new Error(`blurhash length mismatch: length is ${t.length} but it should be ${4+2*o*r}`)})(t),n|=1;const h=e(t[0]),i=Math.floor(h/9)+1,d=h%9+1,u=(e(t[1])+1)/166,c=new Array(d*i);for(let a=0;a<c.length;a++)if(0===a){const r=e(t.substring(2,6));c[a]=l(r)}else{const r=e(t.substring(4+2*a,6+2*a));c[a]=s(r,u*n)}const g=4*a,m=new Uint8ClampedArray(g*o);for(let t=0;t<o;t++)for(let e=0;e<a;e++){let l=0,s=0,n=0;for(let r=0;r<i;r++)for(let h=0;h<d;h++){const i=Math.cos(Math.PI*e*h/a)*Math.cos(Math.PI*t*r/o);let u=c[h+r*d];l+=u[0]*i,s+=u[1]*i,n+=u[2]*i}let h=r(l),u=r(s),b=r(n);m[4*e+0+t*g]=h,m[4*e+1+t*g]=u,m[4*e+2+t*g]=b,m[4*e+3+t*g]=255}return m},t}({});for(let t of document.getElementsByClassName("blurhash-parent")){let e=t.querySelector("img");const a=t.dataset.blurhash;try{const r=Number.parseInt(t.dataset.width),o=Number.parseInt(t.dataset.height);if(e&&a&&r&&o){const l=t.getBoundingClientRect();let s={loaded:!1,blurHashImage:null,width:r,height:o,classes:[]};for(let t of e.classList.values())s.classes.push(t);if(e.classList.add("blurhash-actual-image"),ratio=window.devicePixelRatio||1,r>l.width?(s.width=Math.floor(l.width)/ratio,s.height=Math.floor(o/r*l.width)/ratio):(s.width/=ratio,s.height/=ratio),e.complete){t.classList.add("blurhash-loaded");continue}t.classList.add("blurhash-unloaded"),e.addEventListener("load",(()=>{s.loaded=!0,t.classList.add("blurhash-loaded"),t.classList.remove("blurhash-unloaded"),t.style.minWidth=null,t.style.minHeight=null,t.style.backgroundImage=null,t.style.backgroundSize=null,s.blurHashImage=!1})),setTimeout((()=>{requestAnimationFrame((()=>{const e=blurhash.decode(a,64,64);if(e.length<=0)return;if(s.loaded)return;t.style.minWidth=`${s.width}px`,t.style.minHeight=`${s.height}px`;const r=document.createElement("canvas");let o=r.getContext("2d");r.width=64,r.height=64,o.width=64,o.height=64,o.putImageData(new ImageData(e,64,64),0,0),requestAnimationFrame((()=>{s.loaded||(t.style.backgroundImage=`url(${r.toDataURL()})`,t.style.backgroundSize="cover",s.blurHashImage=!0)}))}))}),30)}}catch(t){console&&console.error&&console.error(t)}}
